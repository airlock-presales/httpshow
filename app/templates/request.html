{% extends "base.html" %}

{% block title %}Request Details{% endblock %}
{% block heading %}Request Details{% endblock %}

{% block content %}
{% if errors %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" class="pico-color-azure-550" onclick="toggleSection(this)">ðŸ‘¤ Errors & Warnings</h5>
    {% for err in errors %}
    {% if err["id"] < 1000 %}
    <p class="error">Error {{ err["id"] }}: {{ err["msg"] }}</p>
    {% else %}
    <p class="warning">Warning {{ err["id"] }}: {{ err["msg"] }}</p>
    {% endif %}
    {% endfor %}
</div>
{% endif %}

{% if user and user.user_id %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" class="pico-color-azure-550" onclick="toggleSection(this)">ðŸ‘¤ Authenticated User
    </h5>
    {% if user.email %}
    <p class="data_value value"><span class="label label_user">Email: </span>{{ user.email or 'N/A' }}</p>
    {% endif %}
    {% if user.name %}
    <p class="data_value value"><span class="label label_user">Name: </span>{{ user.name or 'N/A' }}</p>
    {% endif %}
    <p class="data_value value"><span class="label label_user">User ID: </span>{{ user.user_id }}</p>
</div>
{% endif %}

<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Request Line</h5>
    <div class="content">
        <pre>{{ details.request_line }}</pre>
    </div>
</div>

<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Query Parameters</h5>
    <div class="content">
        {% if details.query_params %}
        <pre>{{ details.query_params | tojson(indent=2) }}</pre>
        {% else %}
        <p class="data_value info">No query parameters</p>
        {% endif %}
    </div>
</div>

<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Headers</h5>
    <div class="content">
        <table>
            <thead>
                <tr>
                    <th>Header</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for key, value in details.headers.items() | sort %}
                <tr>
                    <td class="label label_header">{{ key }}</td>
                    <td><code>{{ value }}</code></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if details.basic_auth %}
        <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107;">
            <h6 class="subheader">ðŸ”“ Basic Auth Decoded</h6>
            <p class="data_value value"><span class="label label_basic_auth">Username:</span> <code>{{ details.basic_auth.username }}</code></p>
            <p class="data_value value"><span class="label label_basic_auth">Password:</span> <code>{{ details.basic_auth.password }}</code></p>
        </div>
        {% endif %}
    </div>
</div>

<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Cookies</h5>
    <div class="content">
        {% if details.cookies %}
        <pre>{{ details.cookies | tojson(indent=2) }}</pre>
        {% else %}
        <p class="data_value info">No cookies</p>
        {% endif %}
    </div>
</div>

<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Request Body</h5>
    <div class="content">
        <p class="data_value {% if details.content %}value{% else %}info{% endif %}"><span class="label label_body">Content-Type: </span>{{ details.content_type or 'Not specified' }}</p>
        {% if details.body_preview %}
        <pre>{{ details.body_preview }}</pre>
        {% else %}
        <p class="data_value info"><span class="label label_body">Body: </span>No body content</p>
        {% endif %}
    </div>
</div>

<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Client Information</h5>
    <div class="content">
        <p class="data_value value"><span class="label label_client">Client IP: </span>{{ details.client_ip }}</p>
        {% if details.forwarded_for %}
        <p class="data_value value"><span class="label label_client">X-Forwarded-For: </span>{{ details.forwarded_for }}
                <span class="data_detail {% if details.forwarded_trust == 'trusted' %}client_trusted{% else %}client_untrusted{% endif %}">
                    ({{ details.forwarded_trust }})
                </span>
        </p>
        {% endif %}
    </div>
</div>

{% if auth_info_details %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Auth Token</h5>
    <div class="content">
        {% if auth_info_details.access_token %}
        {% if auth_info_details.access_token.header %}
        <h6 class="subheader">Header</h6>
        <pre>{{ auth_info_details.access_token.header | tojson(indent=2) }}</pre>
        <h6 class="subheader">Payload</h6>
        <pre>{{ auth_info_details.access_token.payload | tojson(indent=2) }}</pre>
        {% endif %}
        <h6 class="subheader">Raw Token</h6>
        <pre style="word-break: break-all;">{{ auth_info_details.access_token.raw }}</pre>
        {% else %}
        <p class="data_value info">No access token</p>
        {% endif %}
    </div>
</div>

{% if auth_info_details.introspection %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Auth Token Introspection Response</h5>
    <div class="content">
        <pre>{{ auth_info_details.introspection | tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}
{% endif %}

{% if oidc_details %}
{% if oidc_details.id_token %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ OIDC ID Token</h5>
    <div class="content">
        {% if oidc_details.id_token %}
        <h6 class="subheader">Header</h6>
        <pre>{{ oidc_details.id_token.header | tojson(indent=2) }}</pre>
        <h6 class="subheader">Payload</h6>
        <pre>{{ oidc_details.id_token.payload | tojson(indent=2) }}</pre>
        <h6 class="subheader">Raw Token</h6>
        <pre style="word-break: break-all;">{{ oidc_details.id_token.raw }}</pre>
        {% else %}
        <p class="data_value info">No ID token</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if oidc_details.access_token %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ OIDC Access Token</h5>
    <div class="content">
        {% if oidc_details.access_token %}
        {% if oidc_details.access_token.header %}
        <h6 class="subheader">Header</h6>
        <pre>{{ oidc_details.access_token.header | tojson(indent=2) }}</pre>
        <h6 class="subheader">Payload</h6>
        <pre>{{ oidc_details.access_token.payload | tojson(indent=2) }}</pre>
        {% endif %}
        <h6 class="subheader">Raw Token</h6>
        <pre style="word-break: break-all;">{{ oidc_details.access_token.raw }}</pre>
        {% else %}
        <p class="data_value info">No access token</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if oidc_details.refresh_token %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ OIDC Refresh Token</h5>
    <div class="content">
        <pre style="word-break: break-all;">{{ oidc_details.refresh_token }}</pre>
    </div>
</div>
{% endif %}

{% if oidc_details.userinfo %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ UserInfo Endpoint Response</h5>
    <div class="content">
        <pre>{{ oidc_details.userinfo | tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}

{% if oidc_details.introspection %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ Token Introspection Response</h5>
    <div class="content">
        <pre>{{ oidc_details.introspection | tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}

{% if oidc_details.par_request %}
<div class="section collapsible">
    <h5 class="pico-color-azure-550" onclick="toggleSection(this)">â–¼ PAR Request Response</h5>
    <div class="content">
        <pre>{{ oidc_details.par_request | tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}
{% endif %}

{% if api_details %}
{% block api %}{% endblock %}
{% endif %}

<div class="section">
    <h5 class="pico-color-azure-550">ðŸ§ª Test Form</h5>
    <p>Submit data to see how the inspector captures POST bodies:</p>
    <form method="POST" action="/inspect">
        <div>
            <label>Text Field:</label>
            <input type="text" name="test_field" placeholder="Enter some text">
        </div>
        <div>
            <label>Email:</label>
            <input type="email" name="test_email" placeholder="email@example.com">
        </div>
        <div>
            <label>Message:</label>
            <textarea name="test_message" rows="4" placeholder="Enter a message"></textarea>
        </div>
        <button type="submit">Submit Test Data</button>
    </form>
</div>

<script>
    function toggleSection(element) {
        const content = element.nextElementSibling;
        const isHidden = content.style.display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        element.textContent = (isHidden ? 'â–¼' : 'â–¶') + element.textContent.substring(1);
    }
</script>
{% endblock %}